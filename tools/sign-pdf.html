<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign PDF - Online PDF Pro</title>
    <link rel="stylesheet" href="../css/style.css" />
</head>

<body>

    <header>
        <div class="container">
            <h1><a href="../index.html">‚Üê Online PDF Pro</a> / Sign PDF</h1>
        </div>
    </header>

    <main class="container">

        <div class="upload-area" id="dropArea"
            style="border: 2px dashed #ccc; padding: 40px; text-align: center; cursor: pointer; border-radius: 12px; margin-top: 30px;">
            <p>Drop your PDF here or click to upload</p>
            <input type="file" id="fileInput" accept=".pdf" hidden />
        </div>

        <div id="controls" style="display:none; margin:30px 0; text-align:center;">
            <button onclick="clearSig()" class="btn">Clear</button>
            <button onclick="typeSig()" class="btn">Type Name</button>
            <button onclick="savePdf()" class="btn primary">Download Signed PDF</button>
        </div>

        <canvas id="canvas" width="600" height="250"
            style="border:2px solid #000; border-radius:12px; background:white; display:none; max-width: 100%;"></canvas>

        <input type="text" id="nameInput" placeholder="Type your name & press Enter"
            style="display:none; width:100%; padding:15px; margin-top:20px; font-size:20px; border-radius:8px;">

    </main>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/downloadjs@1.4.8/download.min.js"></script>

    <script>
        let pdfBytes = null;
        let signatureImage = null;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'blue';

        let drawing = false;

        // Mouse events
        canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
        canvas.addEventListener('mousemove', e => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
        canvas.addEventListener('mouseup', () => { drawing = false; signatureImage = canvas.toDataURL(); });
        canvas.addEventListener('mouseout', () => drawing = false);

        // Touch support (mobile)
        canvas.addEventListener('touchstart', e => { e.preventDefault(); const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top); });
        canvas.addEventListener('touchmove', e => { e.preventDefault(); const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top); ctx.stroke(); });
        canvas.addEventListener('touchend', () => { drawing = false; signatureImage = canvas.toDataURL(); });

        // Upload
        document.getElementById('dropArea').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = e => {
            const file = e.target.files[0];
            file.arrayBuffer().then(buf => {
                pdfBytes = buf;
                document.getElementById('controls').style.display = 'block';
                canvas.style.display = 'block';
                document.getElementById('dropArea').style.display = 'none';
                alert('PDF loaded! Draw your signature below üëá');
            });
        };

        // Clear
        function clearSig() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureImage = null;
        }

        // Type name
        function typeSig() {
            document.getElementById('nameInput').style.display = 'block';
            document.getElementById('nameInput').focus();
            document.getElementById('nameInput').onkeypress = function (e) {
                if (e.key === 'Enter') {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '70px cursive';
                    ctx.fillStyle = 'blue';
                    ctx.fillText(this.value, 50, 140);
                    signatureImage = canvas.toDataURL();
                    this.style.display = 'none';
                }
            }
        }

        // Download signed PDF
        async function savePdf() {
            if (!pdfBytes) return alert("Upload PDF first");
            if (!signatureImage) return alert("Add signature first");

            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];

            const pngBytes = Uint8Array.from(atob(signatureImage.split(',')[1]), c => c.charCodeAt(0));
            const pngImage = await pdfDoc.embedPng(pngBytes);

            const { width, height } = firstPage.getSize();
            firstPage.drawImage(pngImage, {
                x: width * 0.25,
                y: height * 0.25,
                width: width * 0.5,
                height: height * 0.3,
            });

            const finalPdfBytes = await pdfDoc.save();
            download(finalPdfBytes, "Signed-PDF-OnlinePDFPro.pdf", "application/pdf");
        }
    </script>

</body>

</html>