<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign PDF - Online PDF Pro</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header><div class="container"><h1><a href="/">‚Üê Online PDF Pro</a> / Sign PDF</h1></div></header>
  
  <main class="container">
    <div class="upload-area" id="dropArea">
      <p>Drop PDF here or click to upload</p>
      <input type="file" id="fileInput" accept=".pdf" hidden />
    </div>

    <div id="editor" style="display:none; margin-top:30px;">
      <div style="text-align:center; margin-bottom:20px;">
        <button onclick="clearSignature()" class="btn">Clear Signature</button>
        <button onclick="typeSignature()" class="btn">Type Signature</button>
        <button onclick="downloadPDF()" class="btn primary">Download Signed PDF</button>
      </div>
      
      <div style="border:2px dashed #ccc; border-radius:12px; padding:20px; background:#f9f9f9; margin:20px 0;">
        <p>Draw your signature below:</p>
        <canvas id="signatureCanvas" width="500" height="200" style="border:1px solid #000; background:white; cursor:crosshair; border-radius:8px;"></canvas>
      </div>
      
      <input type="text" id="typeInput" placeholder="Type your name here and press Enter" style="display:none; width:100%; padding:15px; font-size:20px; margin-top:10px; border-radius:8px; border:1px solid #ccc;" />
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/downloadjs@1.4.8/download.min.js"></script>

  <script>
    let originalPdfBytes = null;
    let signatureDataURL = null;
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    // Draw setup
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch support for mobile
    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDrawing(e.touches[0]); });
    canvas.addEventListener('touchmove', e => { e.preventDefault(); draw(e.touches[0]); });
    canvas.addEventListener('touchend', stopDrawing);

    function startDrawing(e) {
      drawing = true;
      const rect = canvas.getBoundingClientRect();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
    }

    function stopDrawing() {
      if (drawing) {
        drawing = false;
        signatureDataURL = canvas.toDataURL('image/png');
      }
    }

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      signatureDataURL = null;
      document.getElementById('typeInput').style.display = 'none';
    }

    function typeSignature() {
      const input = document.getElementById('typeInput');
      input.style.display = 'block';
      input.focus();
      input.onkeypress = function(e) {
        if (e.key === 'Enter') {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = '60px cursive';
          ctx.fillStyle = '#000';
          ctx.fillText(input.value, 50, 120);
          signatureDataURL = canvas.toDataURL('image/png');
          input.style.display = 'none';
        }
      }
    }

    // File upload
    document.getElementById('dropArea').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = e => handleFile(e.target.files[0]);

    async function handleFile(file) {
      if (!file) return;
      originalPdfBytes = await file.arrayBuffer();
      document.getElementById('editor').style.display = 'block';
      alert("PDF loaded! Now draw or type your signature below üëá");
    }

    async function downloadPDF() {
      if (!originalPdfBytes) return alert("Pehle PDF upload karo bhai!");
      if (!signatureDataURL) return alert("Signature daal do pehle!");

      const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
      const pages = pdfDoc.getPages();
      const firstPage = pages[0];

      const pngImageBytes = await fetch(signatureDataURL).then(res => res.arrayBuffer());
      const pngImage = await pdfDoc.embedPng(pngImageBytes);

      const { width, height } = firstPage.getSize();
      firstPage.drawImage(pngImage, {
        x: width / 4,
        y: height / 4,
        width: width / 2,
        height: height / 4,
      });

      const pdfBytes = await pdfDoc.save();
      download(pdfBytes, "signed-by-onlinepdfpro.pdf", "application/pdf");
    }
  </script>
</body>
</html>
